# Архитектура Open Property Core

Документ описывает высокоуровневую архитектуру: модули, границы, технологии и принципы. Детали реализации — в коде и ADR (Architecture Decision Records) при появлении.

- **Фронтенд:** [Feature-Sliced Design](FRONTEND_ARCHITECTURE.md) — слои app → pages → widgets → features → entities → shared.
- **Бэкенд (DRF):** [DDD Django-style](BACKEND_ARCHITECTURE.md) — bounded contexts (Django apps), сервисы, тонкий API-слой.

---

## Цели и ограничения

- **Self-hosted first** — развёртывание у клиента или в своём облаке без привязки к одному вендору.
- **Open core** — ядро под BSL, прозрачная граница Community / Enterprise.
- **Proptech-ready** — учёт объектов, договоров, платежей; запас по интеграциям (IoT, умные замки, биллинг).
- **Комплаенс** — в Enterprise: аудит, документооборот, отчётность (NIS2, 152-ФЗ и т.п.).

---

## Высокоуровневая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                        Клиенты / Интеграции                       │
└─────────────────────────────────────────────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   Admin UI   │  │ Tenant Portal│  │  REST API    │  │  Webhooks /  │
│  (React/Vue) │  │  (опционально)│  │(Django/Nest) │  │  Integrations │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │                 │
       └─────────────────┴────────┬────────┴─────────────────┘
                                  │
                    ┌─────────────▼─────────────┐
                    │      Application Core     │
                    │  (Domain + Use Cases)     │
                    └─────────────┬─────────────┘
                                  │
       ┌─────────────────────────┼─────────────────────────┐
       │                         │                         │
       ▼                         ▼                         ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  PostgreSQL  │  │    Redis     │  │   Queues     │  │  File Store  │
│  (основные   │  │  (кэш,       │  │  (фоны,      │  │  (S3-совм.)  │
│   данные)    │  │   сессии)    │  │   задачи)    │  │              │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
```

---

## Выбор стека бэкенда: Django vs NestJS

Оба варианта подходят для Open Property Core. Итог ниже; выбор можно зафиксировать в ADR при первом коммите.

| Критерий | Django (Python) | NestJS (Node.js/TypeScript) |
|----------|-----------------|-----------------------------|
| **Скорость до MVP** | Выше: Django Admin из коробки, DRF, миграции, админка за часы | Нужно поднимать админку отдельно (React/Vue) или брать AdminJS |
| **Админка** | Встроенная, расширяемая (кастомные формы, действия, права) | Отдельное SPA или сторонние решения (AdminJS, React-Admin) |
| **API** | DRF: сериализаторы, ViewSet, OpenAPI через drf-spectacular | Контроллеры, DTO, Swagger из коробки, строгая типизация |
| **Очереди/фоны** | Celery + Redis — стандарт, зрелый | Bull/BullMQ — нативный для Node, проще один runtime |
| **Типизация** | Опционально (type hints, mypy) | TypeScript по умолчанию, строже на этапе компиляции |
| **Экосистема B2B/ERP** | Ближе: ERPNext (Frappe), много отчётности/интеграций на Python | Много SaaS/API на Node; для тяжёлой логики и отчётов часто тянут Python |
| **Один runtime** | Нет: API на Python, фронт на JS — два стека | Да: бэкенд и фронт на JS/TS, общие типы при монорепо |
| **Proptech / IoT** | Удобно: asyncio, библиотеки для протоколов, скрипты | Удобно: событийная модель, стримы, реальное время |
| **Хостинг** | Любой VPS с Python; меньше «памяти на процесс», чем у Node при равной нагрузке | То же; Node хорошо масштабируется по числу инстансов |

**Когда логичнее Django:**

- Хотите быстрее выйти в прод с работающей админкой и CRUD без отдельной фронт-разработки.
- Планируете тяжёлую отчётность, интеграции с 1С/бухгалтерией, скрипты — в экосистеме Python это часто проще.
- Команда или вы сильнее в Python.

**Когда логичнее NestJS:**

- Нужен один язык (TypeScript) для API и фронта, общие типы и монорепо.
- Упор на современный SPA (React/Vue) с самого начала, админка — кастомная.
- Опыт и предпочтение Node/TS.

**Рекомендация для Open Property Core:** если приоритет — быстрый старт и «админка из коробки», **Django + DRF** даёт выигрыш по времени. Если важнее единый TypeScript-стек и кастомный UI — **NestJS**. Оба стека допускают одну и ту же доменную модель и границы модулей из этого документа.

---

## Стек (целевой)

Ниже — вариант с **двумя допустимыми бэкендами**; при реализации выбирается один.

| Слой | Вариант A (Django) | Вариант B (NestJS) | Общее |
|------|--------------------|--------------------|--------|
| Backend | Python 3.11+, Django 5.x, Django REST Framework | Node.js 20+, NestJS, TypeScript | — |
| API | REST, drf-spectacular (OpenAPI 3) | REST, Swagger/OpenAPI | Версионирование `/api/v1/...` |
| Admin UI | Django Admin (расширяемый) или отдельный SPA | React/Vue + компонентная библиотека | — |
| БД | PostgreSQL (Django ORM, миграции) | PostgreSQL (TypeORM/Prisma/Drizzle) | Одна схема домена |
| Очереди | Celery + Redis | Bull/BullMQ + Redis | Фоны, отложенные задачи |
| Файлы | django-storages (S3-совместимое) | Multer + S3 SDK или аналог | MinIO / AWS S3 |
| Развёртывание | Docker, docker-compose | Docker, docker-compose | Self-hosted из коробки |

---

## Доменные модули (ядро)

Границы модулей — по предметной области, не по слоям.

### 1. Property (Объекты недвижимости)

- **Сущности:** Property, Unit (помещение/квартира), Building (при необходимости).
- **Ответственность:** справочник объектов и помещений, типы, статусы, площадь, адрес.
- **Интеграции (Enterprise):** геокодинг, кадастр (при необходимости).

### 2. Party (Контрагенты)

- **Сущности:** Party (физ./юр. лицо), контакты, роли (арендатор, арендодатель, управляющая компания).
- **Ответственность:** единый справочник контрагентов для договоров и платежей.

### 3. Contract (Договоры)

- **Сущности:** Contract, условия (сроки, сумма, периодичность), статусы (черновик, активен, расторгнут).
- **Ответственность:** жизненный цикл договора аренды/оказания услуг.
- **Enterprise:** юридически значимый документооборот, шаблоны, подписание.

### 4. Billing & Payments (Платежи)

- **Сущности:** Invoice, Payment, тарифы, начисления.
- **Ответственность:** начисление и учёт оплат, связь с договорами.
- **Enterprise:** интеграция с банками, касса, отчётность.

### 5. Integrations (Интеграции)

- **Ответственность:** вебхуки, исходящие API, адаптеры к внешним системам (1С, умные замки, биллинг).
- **Enterprise:** приоритетный модуль для IoT и комплаенс-отчётности.

Модули общаются через доменные события и сервисы приложения; прямые зависимости между агрегатами минимизируются.

---

## API

- **REST** с версионированием в URL или заголовке (`/api/v1/...`).
- **OpenAPI 3** — описание обязательно, генерация клиентов и документации.
- **Аутентификация:** JWT или сессии; для Enterprise — SSO/SAML.
- **Мультитенантность:** на первом этапе — один тенант на инстанс; в перспективе — tenant_id в контексте (организация/УК).

---

## Безопасность и комплаенс (Enterprise)

- Аудит изменений критичных сущностей (кто, когда, что).
- Роли и права (RBAC) — в ядре базовая модель, в Enterprise — детализация под NIS2/152-ФЗ.
- Шифрование чувствительных данных (по необходимости).
- SBOM и прозрачность зависимостей — для корпоративных клиентов.

---

## Масштабирование (позже)

- Горизонтальное масштабирование API за балансировщиком.
- Очереди — отдельные воркеры.
- БД — репликация, при росте — партиционирование по tenant_id или по времени.

Текущий фокус — корректная доменная модель и первый рабочий сценарий; масштабирование закладывается без преждевременной сложности.
